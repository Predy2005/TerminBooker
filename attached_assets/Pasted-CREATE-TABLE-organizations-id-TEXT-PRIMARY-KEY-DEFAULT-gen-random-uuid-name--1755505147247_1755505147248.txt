CREATE TABLE organizations (
  id            TEXT PRIMARY KEY DEFAULT gen_random_uuid(),
  name          TEXT NOT NULL,
  slug          TEXT UNIQUE NOT NULL,
  timezone      TEXT NOT NULL DEFAULT 'Europe/Prague',
  language      TEXT NOT NULL DEFAULT 'cs-CZ',
  created_at    TIMESTAMPTZ NOT NULL DEFAULT now(),
  updated_at    TIMESTAMPTZ NOT NULL DEFAULT now()
);

CREATE TABLE users (
  id               TEXT PRIMARY KEY DEFAULT gen_random_uuid(),
  email            TEXT UNIQUE NOT NULL,
  password_hash    TEXT NOT NULL,
  role             TEXT NOT NULL DEFAULT 'ADMIN',
  organization_id  TEXT NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,
  created_at       TIMESTAMPTZ NOT NULL DEFAULT now()
);

CREATE TABLE services (
  id               TEXT PRIMARY KEY DEFAULT gen_random_uuid(),
  organization_id  TEXT NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,
  name             TEXT NOT NULL,
  duration_min     INT  NOT NULL CHECK (duration_min BETWEEN 5 AND 480),
  price_czk        INT,
  is_active        BOOLEAN NOT NULL DEFAULT TRUE,
  created_at       TIMESTAMPTZ NOT NULL DEFAULT now()
);

-- Týdenní šablony dostupnosti (0=neděle .. 6=sobota)
CREATE TABLE availability_templates (
  id               TEXT PRIMARY KEY DEFAULT gen_random_uuid(),
  organization_id  TEXT NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,
  weekday          INT NOT NULL CHECK (weekday BETWEEN 0 AND 6),
  start_minutes    INT NOT NULL,  -- od půlnoci
  end_minutes      INT NOT NULL,  -- do půlnoci
  slot_step_min    INT NOT NULL,  -- krok slotů
  created_at       TIMESTAMPTZ NOT NULL DEFAULT now()
);

CREATE TABLE blackouts (
  id               TEXT PRIMARY KEY DEFAULT gen_random_uuid(),
  organization_id  TEXT NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,
  starts_at        TIMESTAMPTZ NOT NULL,
  ends_at          TIMESTAMPTZ NOT NULL,
  reason           TEXT
);

CREATE TYPE booking_status AS ENUM ('PENDING','CONFIRMED','CANCELLED');

CREATE TABLE bookings (
  id               TEXT PRIMARY KEY DEFAULT gen_random_uuid(),
  organization_id  TEXT NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,
  service_id       TEXT NOT NULL REFERENCES services(id)       ON DELETE RESTRICT,
  customer_name    TEXT NOT NULL,
  customer_email   TEXT NOT NULL,
  customer_phone   TEXT,
  note             TEXT,
  starts_at        TIMESTAMPTZ NOT NULL,
  ends_at          TIMESTAMPTZ NOT NULL,
  status           booking_status NOT NULL DEFAULT 'PENDING',
  created_at       TIMESTAMPTZ NOT NULL DEFAULT now(),
  updated_at       TIMESTAMPTZ NOT NULL DEFAULT now(),
  CONSTRAINT chk_time CHECK (starts_at < ends_at)
);

-- Unikátní překryv pro tutéž organizaci ve stejném slotu
CREATE UNIQUE INDEX ux_bookings_org_time ON bookings(organization_id, starts_at, ends_at);